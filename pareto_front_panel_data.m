data = [21673	517.11	273618	7255.92	136.08	156.19	517.557992
15718	261.58	51413	5906.3718	88.56	313.7	422.50691
174492	816.29	138157	21699.2248	296.53	6577.89	1555.199068
139434	378.27	82492	20674.0901	196.62	1278.57	1477.637935
167515	306.87	73428	17925.5992	173.44	1872.71	1277.16692
110973	457.05	142378	35527.4764	362.43	2792.02	2520.006092
94191	248.35	60989	10148.3225	168.7	1100	731.045773
160206	289.81	76624	17143.1722	216.07	972.92	1204.127834
12633	234.91	202798	13355.9694	119.12	352.42	945.925244
156094	944.35	239597	41311.6995	847.28	1790.4	2895.504503
115426	901.99	159724	29890.2801	582.99	1322.13	2103.521797
173763	358.74	112095	22920.3988	733.99	6544.02	1641.134958
99535	332.97	105271	17212.0065	330.64	821.44	1221.716939
152067	246.84	106077	17121.4183	307.69	2829.02	1225.851767
252786	1199.71	234278	39011.3553	520.34	5494.78	2809.374949
249831	700.69	234278	30323.995	712.39	4488.01	2150.14735
226912	354.4	145880	29060.1893	415.07	2046.28	2043.325115
235392	366.74	103424	23013.1201	721.93	2329.54	1642.060337
202915	1177.37	380485	56216.736	1202.48	3003.36	4014.163756
111384	276.29	82659	17779.0517	415.73	1857.18	1269.105731
24852	64.8	19638	2918.8525	84.98	75.42	209.681127
122846	192.77	165898	16583.2414	333.27	695.89	1196.361538
301816	573.03	195737	12243.0401	599.15	1273.13	867.683633
172564	201	54795	14474.718	377.87	610.64	1030.58964
222940	374.01	72439	23260.7712	323.1	921.98	1661.741864
165249	336.08	117312	17041.4837	323.14	1685.02	1219.522061
133597	156.38	50523	12562.6588	212.01	811.21	905.928482
70117	58.84	18818	2946.2734	40.33	202.76	212.633722
28554	79.23	15857	3846.7726	58.34	509.43	278.128442
170155	236.96	84780	16628.65	319.62	928.54	1188.9331
21849	530.83	282196	7398.3855	138.3	165.19	527.687999
16110	274.14	51638	6104.419	88.47	349.02	436.810398
179200	930.08	144943	20006.19	290.48	7019.56	1438.763498
140436	424.36	84807	19998.3996	181.99	1363.2	1429.667454
172167	342.14	69230	16376.8753	161.4	2103.47	1163.161215
115430	520.04	136190	37754.1828	375.61	3074.9	2679.823784
96041	284.57	54719	10908.7887	173.27	1190.78	783.990453
162464	322.78	74614	17979.9764	231.23	1008.46	1259.141572
12945	255.03	209885	13433.7126	124.34	300.82	949.875682
157521	1095.45	253433	43578.5227	852	1978.52	3054.542607
116367	1012.05	165213	30121.8821	558.06	1419.43	2118.079025
174373	422.46	116732	25152.1376	799.37	7392.37	1799.72375
101190	386.6	108676	19400.141	334.95	974.8	1374.531878
155515	287.68	103656	17457.6957	316.48	3073.31	1248.123973
259515	1350.25	234715	40309.4422	511.41	5711.38	2903.073772
249857	969.28	242084	29784.36	844.86	4822.37	2114.096
236933	422.23	156845	31167.0773	483.89	2340.56	2190.957061
236250	434.48	107524	25238.9689	776.48	2578.9	1801.409177
212094	1331.84	383629	59013.103	1629.79	3113.84	4210.495332
114900	316.53	79232	19690.4696	413.23	2068.51	1406.087422
26002	75.11	19568	2690.1156	89.08	81.5	192.527942
127392	237.04	181971	15728.0439	352.58	797.8	1132.271153
309742	666.92	207857	17493.2425	630.03	1510.51	1231.624251
179079	244.72	54836	15359.5256	412.92	776.95	1093.471908
230398	429.74	78844	26084.0307	321.06	1002.35	1862.058527
167145	384.88	111184	17918.3142	339.02	1917.45	1282.17351
138084	185.31	48691	12740.9686	229.02	992.6	918.038396
72703	68.84	14738	3368.3316	46.5	234.36	242.946226
31276	91.05	15682	4034.0714	65.68	530.47	291.89729
175468	272.21	82557	17184.36	279.81	1037.32	1228.6674
21885	533.81	288787	6955.7755	130.12	156.36	495.921915
16550	273.62	56129	6352.6065	81.7	345.2	455.047375
184553	1075.03	150198	19750.6775	268.44	6821.48	1419.008503
140960	468.97	84688	20647.995	164.53	1374.76	1477.007814
175374	373.61	66565	14714.2299	160.34	2239.96	1036.820117
120365	582.5	134523	38584.8096	313.09	2850.68	2738.167274
97326	313.74	56383	10092.2726	177.82	1051.22	725.01867
163233	351.75	74505	18036.4355	229.56	929.27	1262.549439
13195	282.23	206868	13788.2296	125.45	289.56	976.585786
158805	1240.91	253790	44943.4322	825.45	2072.96	3151.727256
118015	1120.58	165240	31367.22	544.76	1513.92	2206.248
186940	498.7	123153	25388.8251	574.88	4721.87	1805.058793
104585	435.37	107797	20191.8065	267.29	1020.25	1427.257385
156625	338.94	104811	19071.46	284.74	3022.72	1360.617
263447	1510.81	224541	41262.4012	471.37	5876.99	2970.536706
250584	952.01	249899	31338.5994	743.91	4542.67	2220.339872
252980	498.63	160326	31282.3643	489.29	2380.62	2196.809483
236886	507.88	103606	28563.5103	635.64	2553.52	2039.679161
216023	1471.4	385321	61850.0073	1034.94	3108.81	4408.533547
117993	363.82	78600	21857.8974	410.82	2122.6	1560.169004
26860	83.29	19668	2829.0095	79.29	78.66	202.475181
140551	278.61	179925	19287.9137	376.45	851.23	1388.897423
315582	767.13	192997	15635.6871	671.63	1480.58	1093.791917
186407	292.61	55655	18570.5193	422.79	782.47	1319.254487
236007	484.23	80384	24542.5717	330.21	1077.89	1754.705339
170069	438.12	112248	16900.7508	293.23	1826.8	1206.64344
140052	239.36	48834	11745.97	248.75	912.14	844.3697
75593	78.18	15041	3440.803	44.65	222.13	248.22292
33240	100.94	12640	4076.49	68.04	571.85	294.678488
178263	294.47	80850	20278.3661	249.27	1060.46	1449.697939
22026	547.44	279180	6480.6614	117.67 	161.32 	462.04399
16764	273.69	57471	5916.7411	78.39 	372.49 	424.217729
188431	1245.89	148054	23304.222	244.18 	7294.59 	1675.958636
142066	526.39	83031	20944.1952	141.14 	1452.06 	1497.590676
196061	418.53	69790	14037.8152	152.75 	2423.64 	983.012074
120613	659.41	122195	39294.8615	306.70 	2936.76 	2790.560329
102484	352.93	52935	9786.2266	168.72 	1084.77 	703.125306
164502	394.19	72898	15484.8184	200.10 	904.76 	1075.223876
13292	322.87	196395	15075.2896	114.98 	281.98 	1066.388386
157304	1427.91	259038	46092.782	779.98 	2140.33 	3232.532062
119053	1257.35	165609	30904.1365	465.12 	1626.78 	2165.024803
197588	600.81	128272	25527.3799	491.27 	4915.71 	1814.121921
106757	493.64	104685	21487.4247	251.95 	1094.70 	1516.441283
161909	399.29	103024	19328.2	282.34 	3147.50 	1378.8508
265720	1723.34	224205	42199.5106	472.40 	6071.43 	3037.08666
267441	1104.47	254487	30116.6216	760.57 	4838.53 	2141.68054
260179	588.69	166210	39474.2746	487.33 	2506.86 	2781.576932
238273	595.8	102405	29581.0154	577.03 	2686.57 	2109.305272
218085	1674.64	393904	68766.2324	1079.80 	3381.92 	4891.51416
120547	424.9	75405	22977.6847	390.05 	2248.46 	1630.716039
28217	96.32	21705	2551.0758	75.36 	76.11 	181.618024
142921	327.47	172431	20358.4726	336.75 	935.45 	1466.382258
324138	880.8	191317	23925.5475	597.84 	1565.31 	1681.446413
191626	348.7	55171	20425.2713	443.10 	873.23 	1447.597949
238052	552.05	79584	25341.9957	319.99 	1173.06 	1811.838609
172471	491.23	115492	15254.4028	290.80 	1925.83 	1087.982896
143039	277.25	48593	10810.61	253.26 	949.64 	775.0643
78585	88.65	16308	4042.1573	47.50 	236.04 	291.675059
33940	115.34	11387	4247.93	64.42 	577.56 	306.720488
182085	327.06	79460	21535.4425	213.47 	1102.21 	1539.020925
];

Y_g = data(:,5:6);
X = data(:,1:4);
Y_b = data(:,7);

[n m]=size(X);
[n s]=size(Y_g);
[n p]=size(Y_b);


for i=1:n
    Aeq=[zeros(1,s) X(i,:) zeros(1,s) zeros(1,p)];
    beq=1;
    f=-[zeros(1,s) zeros(1,m) Y_g(i,:) zeros(1,p)];
    A1=[zeros(n,s) -X Y_g zeros(n,p)];
    A2=[Y_g zeros(n,m) -Y_g -Y_b];
    A3=[-0.9*eye(s) zeros(s,m) eye(s) zeros(s,p)];
    A4=[0.5*eye(s) zeros(s,m) -eye(s) zeros(s,p)];
    A=[A1;A2;A3;A4];
    b=zeros(2*n+s+s,1);
    LB=[zeros(1,s+m+s+p)]';   
    w(:,i)=cplexlp(f,A,b,Aeq,beq,LB);
    e1_U(i,1)=-f*w(:,i);
end

for i=1:n
    Aeq=[zeros(1,s) zeros(1,m) zeros(1,s) Y_b(i,:)];
    beq=1;
    f=-[Y_g(i,:) zeros(1,m) -Y_g(i,:) zeros(1,p)];
    A1=[zeros(n,s) -X Y_g zeros(n,p)];
    A2=[Y_g zeros(n,m) -Y_g -Y_b];
    A3=[-0.9*eye(s) zeros(s,m) eye(s) zeros(s,p)];
    A4=[0.5*eye(s) zeros(s,m) -eye(s) zeros(s,p)];
    A=[A1;A2;A3;A4];
    b=zeros(2*n+s+s,1);
    LB=[zeros(1,s+m+s+p)]';   
    w(:,i)=cplexlp(f,A,b,Aeq,beq,LB);
    e2_U(i,1)=-f*w(:,i);
end

for i=1:n
    Aeq=[zeros(1,s) X(i,:) zeros(1,s) zeros(1,p);Y_g(i,:) zeros(1,m) -Y_g(i,:) -e2_U(i,1)*Y_b(i,:)];
    beq=[1;0];
    f=-[zeros(1,s) zeros(1,m) Y_g(i,:) zeros(1,p)];
    A1=[zeros(n,s) -X Y_g zeros(n,p)];
    A2=[Y_g zeros(n,m) -Y_g -Y_b];
    A3=[-0.9*eye(s) zeros(s,m) eye(s) zeros(s,p)];
    A4=[0.5*eye(s) zeros(s,m) -eye(s) zeros(s,p)];
    A=[A1;A2;A3;A4];
    b=zeros(2*n+s+s,1);
    LB=[zeros(1,s+m+s+p)]';   
    w(:,i)=cplexlp(f,A,b,Aeq,beq,LB);
    e1_L(i,1)=-f*w(:,i);
end


for i=1:n
    Aeq=[zeros(1,s) zeros(1,m) zeros(1,s) Y_b(i,:);zeros(1,s) -e1_U(i,1)*X(i,:) Y_g(i,:) zeros(1,p)];
    beq=[1;0];
    f=-[Y_g(i,:) zeros(1,m) -Y_g(i,:) zeros(1,p)];
    A1=[zeros(n,s) -X Y_g zeros(n,p)];
    A2=[Y_g zeros(n,m) -Y_g -Y_b];
    A3=[-0.9*eye(s) zeros(s,m) eye(s) zeros(s,p)];
    A4=[0.5*eye(s) zeros(s,m) -eye(s) zeros(s,p)];
    A=[A1;A2;A3;A4];
    b=zeros(2*n+s+s,1);
    LB=[zeros(1,s+m+s+p)]';   
    w(:,i)=cplexlp(f,A,b,Aeq,beq,LB);
    e2_L(i,1)=-f*w(:,i);
end
delta_e2 = e2_U-e2_L;
delta_e1 = e1_U-e1_L;

for i=1:n 
    if delta_e1(i) >= 0.0001 
        K(i) = floor(delta_e1(i)/0.0001)+1;
        
        for k=1:K(i)+1 
            e1_k(i,k) = e1_U(i) - (k-1)*0.0001;
            e2_k(i,k)=e2_e1_fun(Y_g,X,Y_b,e1_k(i,k),i);
        end
    else
        K(i)=0;
    end
end

tol = 0.000001;

for i=1:n 
    iter = 0;
    gama_U = 1;
    gama_L = 0;
    delta_gama = gama_U - gama_L;
    while delta_gama>tol
        iter = iter + 1;
        gama1 = (gama_U+gama_L)/2;
        Aeq=[zeros(1,s) X(i,:) zeros(1,s) zeros(1,p)];
        beq=[1];
        f=-[zeros(1,s+m+s+p)];
        A1=[zeros(n,s) -X Y_g zeros(n,p)];
        A2=[Y_g zeros(n,m) -Y_g -Y_b];
        A3=[-0.9*eye(s) zeros(s,m) eye(s) zeros(s,p)];
        A4=[0.5*eye(s) zeros(s,m) -eye(s) zeros(s,p)];
        b1=zeros(2*n+s+s,1);
        A5=[zeros(1,s) zeros(1,m) -Y_g(i,:) zeros(1,p)];
        b2=-gama1*e1_U(i);
        A6=[-Y_g(i,:) zeros(1,m) Y_g(i,:) gama1*e2_U(i)*Y_b(i,:)];
        b3=0;
        A=[A1;A2;A3;A4;A5;A6];
        b=[b1;b2;b3];        
        LB=[zeros(1,s+m+s+p)]';   
        [w fval exitflag]=cplexlp(f,A,b,Aeq,beq,LB);
        if exitflag==-2
            gama_U=gama1;
        else
            gama_L=gama1;
        end
            delta_gama = gama_U-gama_L;
            flag1(i,iter) = exitflag;
            delta_gama1(i,iter) = delta_gama;
    end
    gama(i,1)=gama1;
    
end

e1_star = gama.*e1_U;
e2_star = gama.*e2_U;

for i=1:n 
    Aeq=[zeros(1,s) X(i,:) zeros(1,s) zeros(1,p);[-Y_g(i,:) zeros(1,m) Y_g(i,:) e2_star(i)*Y_b(i,:)]];
    beq=[1;0];
    f=-[zeros(1,s) zeros(1,m) Y_g(i,:) zeros(1,p)];
    A1=[zeros(n,s) -X Y_g zeros(n,p)];
    A2=[Y_g zeros(n,m) -Y_g -Y_b];
    A3=[-0.9*eye(s) zeros(s,m) eye(s) zeros(s,p)];
    A4=[0.5*eye(s) zeros(s,m) -eye(s) zeros(s,p)];
    A5=[];
    A=[A1;A2;A3;A4;A5];
    b=zeros(2*n+s+s,1);
    LB=[zeros(1,s+m+s+p)]';   
    w(:,i)=cplexlp(f,A,b,Aeq,beq,LB);
    e1_hat(i,1)=-f*w(:,i);

end


for i=1:n 
    Aeq=[zeros(1,s) zeros(1,m) zeros(1,s) Y_b(i,:);zeros(1,s) -e1_star(i)*X(i,:) Y_g(i,:) zeros(1,p)];
    beq=[1;0];
    f=-[Y_g(i,:) zeros(1,m) -Y_g(i,:) zeros(1,p)];
    A1=[zeros(n,s) -X Y_g zeros(n,p)];
    A2=[Y_g zeros(n,m) -Y_g -Y_b];
    A3=[-0.9*eye(s) zeros(s,m) eye(s) zeros(s,p)];
    A4=[0.5*eye(s) zeros(s,m) -eye(s) zeros(s,p)];
    A5=[];
    A=[A1;A2;A3;A4;A5];
    b=zeros(2*n+s+s,1);
    LB=[zeros(1,s+m+s+p)]';   
    w(:,i)=cplexlp(f,A,b,Aeq,beq,LB);
    e2_hat(i,1)=-f*w(:,i);
    ui = w(1:s,i);
    pi = w(s+m+1:s+m+s,i);
    lambda1(i,1) = (Y_g(i,:)*pi)/(Y_g(i,:)*ui);
    lambda2(i,1) = 1 - lambda1(i,1);
end

E1_hat = 1./e1_hat;
E2_star = 1./e2_star;
E_hat = lambda1.*E1_hat + lambda2.*E2_star;
e_hat = 1./E_hat;
beta1=e1_hat./e1_star;
beta2=e2_hat./e2_star;



results=[e1_U e2_U gama e1_hat e2_star e_hat lambda1 lambda2];

panel_e=reshape(e_hat,30,4);
mean_year_e=mean(panel_e);

panel_e1=reshape(e1_hat,30,4);
mean_year_e1=mean(panel_e1);

panel_e2=reshape(e2_star,30,4);
mean_year_e2=mean(panel_e2);

results2=[panel_e panel_e1 panel_e2];

aa=mean(results2);
aa1=reshape(aa,4,3);

plot(aa1(:,1),'--')
hold on
plot(aa1(:,2),'-*-')
hold on
plot(aa1(:,3),'-')


